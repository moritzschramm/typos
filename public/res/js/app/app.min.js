function app_moduleCallback(e){var t=required_modules.indexOf(e);-1!==t?(e="loaded",required_modules.splice(t,1),0===required_modules.length&&app_changeState(STATE_IDLE)):console.error("Loaded unknown module")}function app_changeState(e){switch(app_state=e,e){case STATE_IDLE:$("#loader").hide(),dp_setNormalText(app_startString);break;case STATE_RUNNING:tm_start();break;case STATE_FINISHED:$("#loader").show(),tm_stop(),app_uploadResults()}}function app_keyPressed(e,t){if(app_state!==STATE_IDLE){if(app_state!==STATE_FINISHED&&!app_handleSpecialKeyPress(e,t)){e=app_replaceSpecialChar(e);var a=dp_normal.charAt(0);if(e!==a&&!app_matchesWhitespace(e,a)||app_inError)app_inError||app_errorCount++,app_inError=!0,misc_assignmentVisible||(kb_unhighlightKey(kb_lastHighlightedKeyId),kb_highlightKey(kb_getKeyIdFromKey("Backspace"))),dp_red.length<5&&dp_setRedText(dp_red+(" "===e?"␣":e));else{tm_keystroke();var i=dp_normal.substring(1,dp_normal.length);if(0===i.length)return void app_nextLine();dp_setGreenText(dp_green+(" "===e?"␣":e)),dp_setNormalText(i),misc_assignmentVisible||kb_unhighlightKey(t),kb_highlightKey(kb_getKeyIdFromKey(app_replaceSpecialChar(i.charAt(0))))}ib_updateBar()}}else app_startLection()}function app_handleSpecialKeyPress(e,t){if("None"===t)return!0;if(-1!==app_silentKeys.indexOf(e))return!0;switch(e){case"Backspace":return dp_red.length>0&&(dp_setRedText(dp_red.substring(0,dp_red.length-1)),0===dp_red.length&&(app_inError=!1,misc_assignmentVisible||kb_unhighlightKey(kb_lastHighlightedKeyId),kb_highlightKey(kb_getKeyIdFromKey(app_replaceSpecialChar(dp_normal.charAt(0)))))),!0;default:return!1}}function app_replaceSpecialChar(e){switch(e){case"Tab":return"↹";case"Enter":return"⏎";case"⏎":return"Enter";case"↹":return"Tab";default:return e}}function app_matchesWhitespace(e,t){return" "===e&&"␣"===t}function app_startLection(){var e=sequence.lines[sequence.index];dp_setNormalText(e),kb_highlightKey(kb_getKeyIdFromKey(e.charAt(0))),$.post(app_trainingNonceURI,function(e,t){"success"==t?(app_nonce=e,app_changeState(STATE_RUNNING)):console.log("Error while retrieving nonce for lection. Status: "+t)})}function app_nextLine(){if(sequence.index++,pb_update(),misc_assignmentVisible||kb_unhighlightKey(kb_lastHighlightedKeyId),sequence.index===sequence.lines.length)return dp_setGreenText(""),dp_setRedText(""),dp_setNormalText(""),void app_changeState(STATE_FINISHED);var e=sequence.lines[sequence.index];dp_setGreenText(""),dp_setRedText(""),dp_setNormalText(e),kb_highlightKey(kb_getKeyIdFromKey(e.charAt(0))),dp_lineSlideIn()}function app_uploadResults(){$.post(app_uploadResultURI,{nonce:app_nonce,errors:app_errorCount,velocity:tm_velocity.toFixed(2),keystrokes:tm_keystrokes},function(e,t){"success"==t?(document.body.onbeforeunload="",window.location.href=app_showResultURI):console.error("Failed to upload results. Status: "+t)})}function dp_init(e){dp_normalTextElement=document.getElementById("normal"),dp_redTextElement=document.getElementById("red"),dp_greenTextElement=document.getElementById("green"),e(app_modules.display)}function dp_setNormalText(e){dp_normal=e,dp_normalTextElement.textContent=dp_normal}function dp_setRedText(e){dp_red=e,dp_redTextElement.textContent=dp_red}function dp_setGreenText(e){dp_green=e,dp_greenTextElement.textContent=dp_green}function dp_lineSlideIn(){$("#normal").addClass("slideRightIn"),setTimeout(function(){$("#normal").removeClass("slideRightIn")},500)}function ib_init(e){ib_velocityElement=$("#velocity"),ib_rightCountElement=$("#rightCount"),ib_errorCountElement=$("#errorCount"),ib_errorRatioElement=$("#errorRatio"),e(app_modules.infobar)}function ib_updateBar(){ib_velocityElement.html(tm_velocity.toFixed(1)),ib_rightCountElement.html(tm_keystrokes),ib_errorCountElement.html(app_errorCount),ib_errorRatioElement.html((100*Math.min(app_errorCount/tm_keystrokes,1)).toFixed(1))}function kb_highlightAllKeys(){for(var e in kb_keys)kb_highlightKey(e)}function kb_unhighlightAllKeys(){for(var e in kb_keys)kb_unhighlightKey(e)}function kb_highlightKey(e){kb_lastHighlightedKeyId=e;var t=kb_keys[e];$("#"+e).addClass(t.highlightClass);var a=kb_getColorFromClass(t.highlightClass);kb_drawConnection(t.parentKeyId,e,a)}function kb_unhighlightKey(e){var t=kb_keys[e];void 0!==t&&$("#"+e).removeClass(t.highlightClass),kb_clearCanvas()}function kb_activateKey(e){$("#"+e).addClass("activekey")}function kb_deactivateKey(e){$("#"+e).removeClass("activekey")}function kb_drawConnection(e,t,a){var i=document.getElementById(e),n=document.getElementById(t),s=i.offsetLeft+i.clientWidth/2,o=i.offsetTop+i.clientHeight/2,r=n.offsetLeft+n.clientWidth/2,l=n.offsetTop+n.clientHeight/2;kb_canvas.strokeStyle=a,kb_canvas.lineWidth=kb_canvas_lineWidth,kb_canvas.globalAlpha=kb_canvas_globalAlpha,kb_canvas.beginPath(),kb_canvas.moveTo(s,o),kb_canvas.lineTo(r,l),kb_canvas.stroke()}function kb_clearCanvas(){kb_canvas.clearRect(0,0,kb_canvas.canvas.width,kb_canvas.canvas.width)}function kb_getColorFromClass(e){switch(e){case"highlightGreen":return"#00c853";case"highlightPurple":return"#673ab7";case"highlightRed":return"#f44336";case"highlightYellow":return"#ffc107";default:return"#03a9f4"}}function kb_init(e){$.get(kb_layoutURI+kb_layout+".json",function(t,a){if("success"==a){kb_locale=t.meta.locale,kb_ratio=t.meta.ratio;for(var i="",n=0;n<t.keys.length;n++){var s=t.keys[n],o=s.id,r=s.label,l="left:"+s.left+"%;",_="top:"+s.top+"%;",d=s.parentKeyId,c=s.highlightClass,p="key",h="";if(void 0!==s.classes)for(var u=0;u<s.classes.length;u++)p+=" "+s.classes[u];if(void 0!==s.style&&(h+=s.style),kb_keys[o]={label:r,parentKeyId:d,highlightClass:c},void 0!==s.map.special){var m=void 0!==s.map.location?s.map.location:"";kb_specialMap[s.map.special+m]=o}else kb_defaultMap[s.map.default]=o,kb_shiftMap[s.map.shift]=o,kb_altGrMap[s.map.altGr]=o;i+='<div id="'+o+'" class="'+p+'" style="'+l+_+h+'">'+r+"</div>"}i+='<canvas class="hud" id="hud" width="960" height="320"></canvas>',$("#keyboard").append(i),(kb_canvas=document.getElementById("hud").getContext("2d")).lineWidth=kb_canvas_lineWidth,kb_canvas.globalAlpha=kb_canvas_globalAlpha,kb_setSize(),e(app_modules.keyboard)}else console.error("Error while fetching keyboard layout. Returned status code: "+a)})}function kb_setSize(){kb_width=$("#keyboard").width(),kb_height=kb_width/kb_ratio,$("#keyboard").css("height",kb_height+"px"),kb_canvas.canvas.width=kb_width,kb_canvas.canvas.height=kb_height}function kb_handleKeyDown(e){var t=kb_getKeyIdFromKeyEvent(e);return"CapsLock"!==t&&(kb_activateKey(t),app_keyPressed(e.key,t)),t}function kb_handleKeyUp(e){var t=kb_getKeyIdFromKeyEvent(e);return"CapsLock"===t?(kb_capslockPressed(kb_specialMap[t]),t="None"):kb_deactivateKey(t),t}function kb_getKeyIdFromKeyEvent(e){var t=kb_getKeyLocation(e);return kb_getKeyIdFromKey(e.key,t)}function kb_getKeyIdFromKey(e,t){var a="None";return void 0===t&&(t=""),e in kb_defaultMap?a=kb_defaultMap[e]:e in kb_shiftMap?a=kb_shiftMap[e]:e in kb_altGrMap?a=kb_altGrMap[e]:e+t in kb_specialMap?a="CapsLock"===e?e:kb_specialMap[e+t]:" "!==e&&"␣"!==e||(a=kb_specialMap.Space),a}function kb_getKeyLocation(e){var t="";return e.location===KeyboardEvent.DOM_KEY_LOCATION_LEFT?t="left":e.location===KeyboardEvent.DOM_KEY_LOCATION_RIGHT&&(t="right"),t}function kb_capslockPressed(e){(kb_isCapslock=!kb_isCapslock)?kb_activateKey(e):kb_deactivateKey(e)}function misc_init(e){misc_keyboardVisible?misc_showKeyboard():misc_hideKeyboard(),misc_assignmentVisible?misc_showAssignment():misc_hideAssignment(),misc_dividerVisible?misc_showDivider():misc_hideDivider(),e(app_modules.misc)}function back(){$("#modal_back").modal("show")}function backConfirm(){document.body.onbeforeunload="",window.location.href=misc_backURI}function toggleAssignment(){misc_assignmentVisible?misc_hideAssignment():misc_showAssignment(),misc_assignmentVisible=!misc_assignmentVisible}function toggleDivider(){misc_dividerVisible?misc_hideDivider():misc_showDivider(),misc_dividerVisible=!misc_dividerVisible}function toggleKeyboard(){misc_keyboardVisible?misc_hideKeyboard():misc_showKeyboard(),misc_keyboardVisible=!misc_keyboardVisible}function misc_showAssignment(){$("#assignment-state").removeClass("glyphicon-unchecked"),$("#assignment-state").addClass("glyphicon-check"),$("#fingerInfo").removeClass("gone"),kb_highlightAllKeys()}function misc_hideAssignment(){$("#assignment-state").addClass("glyphicon-unchecked"),$("#assignment-state").removeClass("glyphicon-check"),$("#fingerInfo").addClass("gone"),kb_unhighlightAllKeys()}function misc_showDivider(){$("#divider-state").addClass("glyphicon-check"),$("#divider-state").removeClass("glyphicon-unchecked"),$("#divider").removeClass("gone")}function misc_hideDivider(){$("#divider-state").removeClass("glyphicon-check"),$("#divider-state").addClass("glyphicon-unchecked"),$("#divider").addClass("gone")}function misc_showKeyboard(){$("#keyboard-state").removeClass("glyphicon-unchecked"),$("#keyboard-state").addClass("glyphicon-check"),$("#keyboard").removeClass("gone")}function misc_hideKeyboard(){$("#keyboard-state").addClass("glyphicon-unchecked"),$("#keyboard-state").removeClass("glyphicon-check"),$("#keyboard").addClass("gone")}function pb_init(e){pb_element=$("#progressbar"),e(app_modules.progressbar)}function pb_update(){var e=sequence.index/sequence.lines.length*100;pb_element.css("width",e+"%")}function sq_init(e){$.post(sq_dataURI,function(t,a){if("success"==a){if(is_set(t.meta)){var i=t.meta;app_uploadResultURI=is_set(i.uploadResultURI)?i.uploadResultURI:app_uploadResultURI,app_showResultURI=is_set(i.showResultURI)?i.showResultURI:app_showResultURI}sq_prepareSequence(t.lines),e(app_modules.sequence)}else console.error("Failed to load sequence. Returned status code: "+a)})}function sq_prepareSequence(e){for(key in e){var t=e[key];t=(t=(t=t.replace(/\n/g,"⏎")).replace(/\t/g,"↹")).replace(/ /g,"␣"),sequence.lines.push(t)}}function is_set(e){return void 0!==e}function tm_init(e){e(app_modules.typometer)}function tm_start(){tm_startTime=Date.now(),tm_intervalId=setInterval(tm_calculate,tm_intervalTime)}function tm_stop(){clearInterval(tm_intervalId)}function tm_keystroke(){tm_keystrokes++,tm_calculate()}function tm_calculate(){tm_currentTime=Date.now(),tm_velocity=tm_keystrokes/((tm_currentTime-tm_startTime)/6e4),ib_updateBar()}var STATE_LOADING=0,STATE_IDLE=1,STATE_RUNNING=2,STATE_FINISHED=3,app_state=STATE_LOADING,app_inError=!1,app_errorCount=0,app_nonce="",app_startString="",app_silentKeys=["Shift","AltGraph","Alt","Control"],app_uploadResultURI="/results/upload",app_showResultURI="/results/show",app_trainingNonceURI="/training/nonce",app_modules={keyboard:"keyboard",display:"display",sequence:"sequence",typometer:"typometer",misc:"misc",infobar:"infobar",progressbar:"progressbar"},required_modules=[app_modules.keyboard,app_modules.display,app_modules.sequence,app_modules.typometer,app_modules.misc,app_modules.infobar,app_modules.progressbar],dp_normal="",dp_red="",dp_green="",dp_normalTextElement,dp_redTextElement,dp_greenTextElement,ib_velocityElement,ib_rightCountElement,ib_errorCountElement,ib_errorRatioElement,kb_lastHighlightedKeyId,kb_keys=[],kb_canvas,kb_specialMap=[],kb_defaultMap=[],kb_shiftMap=[],kb_altGrMap=[],kb_layout="",kb_locale="",kb_width=0,kb_height=0,kb_ratio=3,kb_canvas_lineWidth=2,kb_canvas_globalAlpha=.8,kb_isCapslock=!1,kb_layoutURI="/res/js/keyboard_layouts/";$(window).resize(kb_setSize),$(document).unbind("keydown").bind("keydown",function(e){(8===e.keyCode||9===e.keyCode||32===e.keyCode||e.shiftKey||17===e.keyCode||18===e.keyCode||"Backspace"===e.key||"Tab"===e.key||" "===e.key||"Control"===e.key||"Alt"===e.key)&&e.preventDefault()}),document.addEventListener("keydown",kb_handleKeyDown),document.addEventListener("keyup",kb_handleKeyUp);var misc_assignmentVisible=!1,misc_dividerVisible=!1,misc_keyboardVisible=!0,misc_backURI="/dashboard",pb_element,sequence={index:0,lines:[],errors:[]},sq_dataURI="",sq_maxLineLength=20,tm_startTime,tm_currentTime,tm_velocity=0,tm_keystrokes=0,tm_intervalTime=2500,tm_intervalId;